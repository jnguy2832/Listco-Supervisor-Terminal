<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Candy Recovery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #fff8f0;
      font-family: 'Segoe UI', 'Roboto', sans-serif;
    }
    .menu-header {
      background-color: rgb(255, 240, 173);
      color: rgb(90, 66, 150);
      padding: 1rem;
      text-align: center;
      border-bottom: 2px solid rgb(90, 66, 150);
    }
    .menu-header img {
      width: 240px;
      height: auto;
      margin-bottom: 0.5rem;
    }
    .menu-header h3 {
      font-weight: 800;
      font-size: 1.5rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .dashboard-link {
      margin: 1rem;
    }
    .tracker-section {
      background-color: white;
      margin: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .tracker-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .tracker-table th, .tracker-table td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.9rem;
      padding: 0.5rem;
    }
    .tracker-table th {
      background-color: rgb(255, 243, 200);
      color: rgb(90, 66, 150);
    }
    .employee-name {
      font-weight: 600;
    }
    .current-datetime {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      font-weight: 600;
      color: rgb(90, 66, 150);
      justify-content: flex-start;
    }
    .current-datetime div {
      min-width: 120px;
      white-space: nowrap;
    }
    .current-datetime div strong {
      color: rgb(90, 66, 150);
    }
  </style>
</head>
<body onload="updateCurrentDateTime()">

  <div class="menu-header">
    <img src="/static/logo.png" alt="Listco Logo" />
    <h3>Candy Recovery</h3>
  </div>

  <div class="dashboard-link text-start">
    <a href="/" class="btn btn-outline-primary">Back to Dashboard</a>
  </div>

  <div class="tracker-section">
    <div class="tracker-header w-100">
      <div class="current-datetime">
        <div><strong>Date:</strong> <span id="currentDate"></span></div>
        <div><strong>Day:</strong> <span id="currentDay"></span></div>
        <div><strong>Time:</strong> <span id="currentTime"></span></div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered tracker-table">
        <thead>
          <tr>
            <th>Employee</th>
            <th>Date</th>
            <th>Start Shift</th>
            <th>End Shift</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody id="trackerBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Live date/day/time
    function updateCurrentDateTime() {
      const now = new Date();
      const optionsDate = { month: 'short', day: 'numeric', year: 'numeric' };
      const optionsDay = { weekday: 'long' };

      document.getElementById('currentDate').textContent = now.toLocaleDateString(undefined, optionsDate);
      document.getElementById('currentDay').textContent = now.toLocaleDateString(undefined, optionsDay);
      document.getElementById('currentTime').textContent = now.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
    }
    setInterval(updateCurrentDateTime, 1000);

    // WebSocket setup
    function buildWsUrl(path) {
      const origin = window.location.origin || (window.location.protocol + '//' + window.location.host);
      let wsOrigin = origin.replace(/^http/, 'ws');
      let full = wsOrigin.replace(/\/$/, '') + '/' + path.replace(/^\//, '');
      full = full.replace(/([^:]\/\/)\/+/g, '$1');
      return full;
    }

    const wsUrl = buildWsUrl('/ws/breaks/');
    let breakSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectWebSocket(){
      breakSocket = new WebSocket(wsUrl);

      breakSocket.onopen = function() {
        reconnectAttempts = 0;
        updateConnectionStatus(true);
      };

      breakSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'initial_data' || data.type === 'breaks_update') {
          renderEmployees(data.breaks);
        }
      };

      breakSocket.onclose = function() {
        updateConnectionStatus(false);
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          setTimeout(connectWebSocket, 3000);
        }
      };
      breakSocket.onerror = function(error) {
        console.error('WebSocket error: ', error);
      };
    }

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      if (connected) {
        statusEl.textContent = 'Connected';
        statusEl.className = 'connection-status status-connected';
      } else {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'connection-status status-disconnected';
      }
    }

    function formatTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true});
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    }

    // Render only candy employees
    function renderEmployees(breaks) {
      const tbody = document.getElementById('trackerBody');
      tbody.innerHTML = "";

      if (!breaks || breaks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No Shifts Scheduled Today</td></tr>';
        return;
      }

      // Group by employee
      const shiftsMap = new Map();
      breaks.forEach(b => {
        const key = b.employee_name;
        if (!shiftsMap.has(key)) {
          shiftsMap.set(key, {
            employee_name: b.employee_name,
            job_title: b.job_title || "",
            shift_start: b.shift_start,
            shift_end: b.shift_end,
            location: b.location
          });
        }
      });

      let html = '';
      shiftsMap.forEach(emp => {
        if (emp.job_title && emp.job_title.toLowerCase() === "candy") {
          html += `
            <tr>
              <td><div class="employee-name">${emp.employee_name}</div></td>
              <td>${emp.shift_start ? formatDate(emp.shift_start) : ''}</td>
              <td>${emp.shift_start ? formatTime(emp.shift_start) : ''}</td>
              <td>${emp.shift_end ? formatTime(emp.shift_end) : ''}</td>
              <td>${emp.location || ''}</td>
            </tr>`;
        }
      });

      if (!html) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No Candy Employees Found</td></tr>';
      } else {
        tbody.innerHTML = html;
      }
    }

    connectWebSocket();
    setInterval(() => {
      if (breakSocket && breakSocket.readyState === WebSocket.OPEN) {
        breakSocket.send(JSON.stringify({type: 'update'}));
      }
    }, 30000);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
